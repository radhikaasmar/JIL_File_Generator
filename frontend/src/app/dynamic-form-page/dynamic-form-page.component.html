<div class="dynamic-form-container">
  <div class="form-header">
    <h1>Dynamic Form Configuration</h1>
  </div>

  <!-- Subform Instances -->
  <div class="subforms-container">
    <div
      *ngFor="let instance of subformInstances; trackBy: trackByInstanceId"
      class="subform-wrapper"
      [ngClass]="'subform-' + instance.type">

      <!-- Subform Header -->
      <div class="subform-header">
        <div class="header-left">
          <h2>{{ instance.displayName }}</h2>
        </div>
        <button
          *ngIf="instance.removable"
          (click)="removeSubformInstance(instance.id)"
          class="remove-btn"
          type="button">
          Remove
        </button>
      </div>

      <!-- Job Name Display for non-top subforms -->
      <div *ngIf="instance.type !== 'top'" class="job-name-display">
        <strong>Job Name:</strong> {{ getJobNameForInstance(instance) }}
        <div *ngIf="isJobNameTruncated(instance)" class="warning">
          Warning: Job name is limited to 60 characters and has been truncated.
        </div>
      </div>

      <!-- Dynamic Form Viewer for this subform -->
      <app-dynamic-form-viewer
        [sections]="instance.sections"
        [form]="instance.form"
        [subformContext]="instance"
        (formChange)="onSubformChange(instance)">
      </app-dynamic-form-viewer>
    </div>
  </div>

  <div class="function-button-group">
  <div class="function-buttons-row">
    <!-- Add CFW Button -->
    <button class="btn-function btn-add-cfw" (click)="addCfwFunction()">
      <span class="btn-function-icon">üîÑ</span>
      Add CFW
    </button>

    <!-- Add FW Button -->
    <button class="btn-function btn-add-fw" (click)="addFwFunction()">
      <span class="btn-function-icon">üëÅÔ∏è</span>
      Add FW
    </button>

    <!-- Add CMD Button with Dropdown -->
    <div class="cmd-dropdown-container">
      <button class="btn-function btn-add-cmd" (click)="toggleCmdDropdown()">
        <span class="btn-function-icon">‚ö°</span>
        Add CMD
        <span class="btn-function-icon">‚ñº</span>
      </button>
      
      <div class="cmd-dropdown" [class.show]="showAddCmdDropdown">
        <div class="cmd-dropdown-item" 
             *ngFor="let option of getCmdOptions()" 
             (click)="addCmdFunction(option)">
          <span>{{ option.label }}</span>
        </div>
      </div>
    </div>
  </div>
</div>


 <!-- JIL Actions Section -->
  <div class="jil-actions-section" *ngIf="getAvailableEnvironments().length > 0">
    <div class="actions-header">
      <h3>JIL File Actions</h3>
    </div>

    <div class="actions-content">
      <div class="buttons-row">
        <div class="preview-group">
          <label class="section-label">Preview JIL Files:</label>
          <div class="preview-buttons">
            <button
              *ngFor="let env of getAvailableEnvironments()"
              class="btn btn-preview"
              (click)="previewJILForEnvironment(env)"
              [title]="'Preview JIL for ' + env.toUpperCase() + ' environment'">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
              </svg>
              Preview {{ env.toUpperCase() }}
            </button>
          </div>
        </div>

        <div class="download-group">
          <button class="btn btn-download" (click)="downloadJILFiles()">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
            Download All JIL Files
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- JIL Output Component -->
  <app-jil-output
  [generatedJIL]="previewJILContent"
  [showJIL]="showJILPreview"
  [environment]="previewEnvironment"
  [jobName]="previewJobName"
  (closePreview)="closeJILPreview()"
  (downloadJIL)="downloadFromPreview($event)">
</app-jil-output>
</div>
