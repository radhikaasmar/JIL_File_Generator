<div class="dynamic-form-container">
  <div class="form-header">
    <h1>Dynamic Form Configuration</h1>
  </div>

  <!-- Subform Instances -->
  <div class="subforms-container">
    <div
      *ngFor="let instance of subformInstances; trackBy: trackByInstanceId"
      class="subform-wrapper"
      [ngClass]="'subform-' + instance.type">

      <!-- Subform Header -->
      <div class="subform-header">
        <div class="header-left">
          <h2>{{ instance.displayName }}</h2>
        </div>
        <button
          *ngIf="instance.removable"
          (click)="removeSubformInstance(instance.id)"
          class="remove-btn"
          type="button">
          Remove
        </button>
      </div>

      <!-- Job Name Display for non-top subforms -->
      <div *ngIf="instance.type !== 'top'" class="job-name-display">
        <strong>Job Name:</strong> {{ getJobNameForInstance(instance) }}
        <div *ngIf="isJobNameTruncated(instance)" class="warning">
          Warning: Job name is limited to 60 characters and has been truncated.
        </div>
      </div>

      <!-- Dynamic Form Viewer for this subform -->
      <app-dynamic-form-viewer
        [sections]="instance.sections"
        [form]="instance.form"
        [subformContext]="instance"
        (formChange)="onSubformChange(instance)">
      </app-dynamic-form-viewer>
    </div>
  </div>

  <!-- Add Function Buttons Section -->
  <div class="add-function-buttons-section">
    <div class="section-header">
      <h3>Add Function Jobs</h3>
      <p class="section-description">Add specific job types to your configuration</p>
    </div>

    <div class="function-buttons-container">
      <!-- Add CMD Button -->
      <div class="function-button-group">
        <button 
          class="add-function-btn cmd-btn" 
          (click)="showAddCmdDropdown = !showAddCmdDropdown"

          >
          <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Add CMD
        </button>
        
        <!-- CMD Dropdown -->
        <div class="cmd-dropdown" [class.show]="showAddCmdDropdown" *ngIf="showAddCmdDropdown">
          <div class="dropdown-header">
            <span>Select CMD Function</span>
            <button class="close-dropdown" (click)="showAddCmdDropdown = false">Ã—</button>
          </div>
          <div class="dropdown-options">
            <button 
              *ngFor="let option of getCmdOptions()" 
              class="dropdown-option"
              (click)="addCmdFunction(option)">
              {{ option.label }}
            </button>
          </div>
        </div>
      </div>

      <!-- Add FW Button -->
      <button 
        class="add-function-btn fw-btn" 
        (click)="addFwFunction()"
>
        <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
        </svg>
        Add FW
      </button>

      <!-- Add CFW Button -->
      <button 
        class="add-function-btn cfw-btn" 
        (click)="addCfwFunction()">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Add CFW
      </button>
    </div>
  </div>

 <!-- JIL Actions Section -->
  <div class="jil-actions-section" *ngIf="getAvailableEnvironments().length > 0">
    <div class="actions-header">
      <h3>JIL File Actions</h3>
    </div>

    <div class="actions-content">
      <div class="buttons-row">
        <div class="preview-group">
          <label class="section-label">Preview JIL Files:</label>
          <div class="preview-buttons">
            <button
              *ngFor="let env of getAvailableEnvironments()"
              class="btn btn-preview"
              (click)="previewJILForEnvironment(env)"
              [title]="'Preview JIL for ' + env.toUpperCase() + ' environment'">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
              </svg>
              Preview {{ env.toUpperCase() }}
            </button>
          </div>
        </div>

        <div class="download-group">
          <button class="btn btn-download" (click)="downloadJILFiles()">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
            Download All JIL Files
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- JIL Output Component -->
  <app-jil-output
  [generatedJIL]="previewJILContent"
  [showJIL]="showJILPreview"
  [environment]="previewEnvironment"
  [jobName]="previewJobName"
  (closePreview)="closeJILPreview()"
  (downloadJIL)="downloadFromPreview($event)">
</app-jil-output>
</div>
